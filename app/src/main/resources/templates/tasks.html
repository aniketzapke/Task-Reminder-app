<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>All Tasks</title>


    <link rel="stylesheet" th:href="@{/css/app.css}">


    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css"
          rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
</head>

<body>

<div class="page-wrapper">
    <div class="filter-bar">

        <a class="btn btn-add" th:href="@{/api/tasks/add}">
            + Add Task
        </a>

        <button class="btn btn-secondary" onclick="openCalendar()">
            ðŸ“… Calendar View
        </button>

        <form class="filter-form" th:action="@{/api/tasks/task}" method="get">

            <select name="status">
                <option value="">All Status</option>
                <option value="PENDING">Pending</option>
                <option value="IN_PROGRESS">In Progress</option>
                <option value="DONE">Done</option>
            </select>

            <select name="priority">
                <option value="">All Priority</option>
                <option value="HIGH">High</option>
                <option value="MEDIUM">Medium</option>
                <option value="LOW">Low</option>
            </select>

            <input type="text" name="keyword"
                   placeholder="ðŸ” Search by title..."
                   th:value="${param.keyword}" />

            <button type="submit" class="btn btn-primary">Filter</button>
            <a th:href="@{/api/tasks/task}" class="btn btn-secondary">Clear</a>
        </form>

        <div class="sort-box">
            <span>Sort by:</span>
            <a th:href="@{/api/tasks/task(sort='dueDate')}">ðŸ“… Due Date</a>
            <a th:href="@{/api/tasks/task(sort='priority')}">âš¡ Priority</a>
            <a th:href="@{/api/tasks/task(sort='title')}">ðŸ”¤ Title</a>
        </div>
    </div>

    <table>
        <thead>
        <tr>
            <th>ID</th>
            <th>Title</th>
            <th>Description</th>
            <th>Due Date</th>
            <th>Status</th>
            <th>Priority</th>
            <th>Created At</th>
            <th>Completed At</th>
            <th>Actions</th>
        </tr>
        </thead>

        <tbody>
        <tr th:each="task : ${tasks}">
            <td th:text="${task.id}"></td>
            <td th:text="${task.title}"></td>
            <td th:text="${task.description}"></td>
            <td th:text="${task.dueDate}"></td>

            <td>
                <span th:text="${task.status}"
                      th:class="'status-' + ${#strings.toLowerCase(task.status.name())}">
                </span>
            </td>

            <td>
                <span th:text="${task.priority}"
                      th:class="'badge badge-' + ${#strings.toLowerCase(task.priority.name())}">
                </span>
            </td>

            <td th:text="${#temporals.format(task.createdAt, 'dd-MM-yyyy')}"></td>

            <td>
                <span th:text="${task.completedAt != null
                        ? #temporals.format(task.completedAt, 'dd-MM-yyyy')
                        : '-'}">
                </span>
            </td>

            <td class="actions">
                <a class="btn btn-secondary"
                   th:href="@{/api/tasks/view/{id}(id=${task.id})}">View</a>

                <a class="btn btn-primary"
                   th:href="@{/api/tasks/edit/{id}(id=${task.id})}">Edit</a>

                <a class="btn btn-danger"
                   th:href="@{/api/tasks/delete/{id}(id=${task.id})}"
                   onclick="return confirm('Are you sure?');">Delete</a>

                <a th:if="${task.status.name() == 'IN_PROGRESS'}"
                   class="btn btn-success"
                   th:href="@{/api/tasks/done/{id}(id=${task.id})}">
                    Mark Done
                </a>
            </td>
        </tr>
        </tbody>
    </table>
</div>

<footer>
    Task Reminder App Â© 2025 â€” Created by Student
</footer>

<div id="calendarModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ðŸ“… Task Calendar</h3>
            <span class="close" onclick="closeCalendar()">&times;</span>
        </div>
        <div id="calendar"></div>
    </div>
</div>
<script th:inline="javascript">
    var calendarEvents = [
        /*[# th:each="task : ${tasks}"]*/
        {
            title: /*[[${task.title}]]*/,
            start: /*[[${task.dueDate}]]*/,
            color:
                /*[[${task.priority.name()}]]*/ === 'HIGH' ? '#e74c3c' :
                /*[[${task.priority.name()}]]*/ === 'MEDIUM' ? '#f39c12' :
                '#2ecc71'
        },
        /*[/]*/
    ];
</script>
<script th:inline="javascript">

    let calendar;

    function openCalendar() {
        document.getElementById("calendarModal").style.display = "block";

        if (!calendar) {
            let tasks = [[${tasks}]];

            let events = tasks.map(task => ({
                title: task.title,
                start: task.dueDate,
                url: '/api/tasks/view/' + task.id,
                color:
                    task.status === 'DONE' ? '#2ecc71' :
                    task.status === 'IN_PROGRESS' ? '#f39c12' :
                    '#e74c3c'
            }));

            let calendarEl = document.getElementById('calendar');

            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                height: 'auto',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: events
            });

            calendar.render();
        }
    }

    function closeCalendar() {
        document.getElementById("calendarModal").style.display = "none";
    }

</script>


</body>
</html>
